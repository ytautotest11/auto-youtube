name: Auto YouTube Upload

on:
  schedule:
    # === LONG VIDEOS ===
    - cron: "0 4 * * *"
    - cron: "30 4 * * *"

    # === INFO REEL SHORTS ===
    - cron: "30 3 * * *"
    - cron: "30 6 * * *"
    - cron: "30 9 * * *"
    - cron: "30 12 * * *"

    # === MIND POP INDIA SHORTS ===
    - cron: "0 4 * * *"
    - cron: "0 7 * * *"
    - cron: "0 10 * * *"
    - cron: "0 13 * * *"

  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Install Python
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # -----------------------------
      # 3. Install FFmpeg (required for MoviePy)
      # -----------------------------
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # -----------------------------
      # 4. Install ImageMagick (needed for MoviePy/text)
      # -----------------------------
      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      # -----------------------------
      # 5. FIX ImageMagick security policy
      # (DEFAULT IMAGE POLICIES BLOCK TEXT RENDERING)
      # -----------------------------
      - name: Fix ImageMagick Security Policy
        run: |
          FILE="/etc/ImageMagick-6/policy.xml"
          if [ -f "$FILE" ]; then
            sudo sed -i 's/rights="none"/rights="read|write"/g' $FILE
            sudo sed -i 's/rights="read"/rights="read|write"/g' $FILE
          fi

      # -----------------------------
      # 6. Install Python dependencies
      # -----------------------------
      - name: Install Python Dependencies
        run: pip install -r requirements.txt

      # -----------------------------
      # 7. Run Bot
      # -----------------------------
      - name: Run YouTube Automation Bot
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON }}
          YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
        run: python main.py
